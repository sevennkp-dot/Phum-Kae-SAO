<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏≠‡∏ö‡∏ï.‡∏û‡∏∏‡πà‡∏°‡πÅ‡∏Å ‚Äî ‡πÅ‡∏≠‡∏õ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { box-sizing: border-box; }
    .loading { display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #dc2626;border-radius:50%;animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
    .toast { position:fixed;left:50%;transform:translateX(-50%) translateY(-20px);top:24px;padding:12px 20px;border-radius:12px;color:white;font-weight:600;z-index:1000;opacity:0;transition:all .28s ease; }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    .toast.success { background-color:#10b981; }
    .toast.error { background-color:#ef4444; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:2000; }
    .modal { background:white; padding:18px; border-radius:14px; max-width:420px; width:92%; box-shadow:0 12px 40px rgba(0,0,0,0.25); }
    @keyframes pop { from{opacity:0; transform:translateY(8px) scale(.98);} to{opacity:1; transform:translateY(0) scale(1);} }
    .animate-pop { animation: pop .28s ease both; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-red-50 via-orange-50 to-yellow-50 text-gray-800 antialiased">

  <!-- Mobile App Frame -->
  <div class="max-w-md mx-auto min-h-screen flex flex-col">

    <!-- App Header -->
    <header class="flex items-center justify-between p-4 bg-white/60 backdrop-blur-sm sticky top-0 z-30">
      <div class="flex items-center space-x-3">
        <div class="w-12 h-12 rounded-xl bg-red-600 flex items-center justify-center shadow-md">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13M7.5 5C5.754 5 4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18S11 18.477 12.5 19.253"></path></svg>
        </div>
        <div>
          <div class="text-sm text-gray-500">‡∏≠‡∏ö‡∏ï.‡∏û‡∏∏‡πà‡∏°‡πÅ‡∏Å</div>
          <div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</div>
        </div>
      </div>
      <button id="openLoginBtn" class="text-sm text-gray-600 underline">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </header>

    <!-- Content -->
    <main class="flex-1 p-4 pb-24">

      <!-- Primary Card -->
      <section class="bg-white rounded-3xl p-5 shadow-lg animate-pop">
        <h2 class="text-xl font-bold text-red-700 mb-1">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h2>
        <p class="text-sm text-gray-500 mb-4">‡∏Å‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏°‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏</p>

        <form id="emergencyForm" class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="inputName" type="text" name="name" required class="w-full px-4 py-3 border rounded-xl text-base focus:outline-none focus:ring-2 focus:ring-red-200" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input id="inputPhone" type="tel" name="phone" required class="w-full px-4 py-3 border rounded-xl text-base focus:outline-none focus:ring-2 focus:ring-red-200" placeholder="0812345678" />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
            <select id="inputType" name="incident_type" required class="w-full px-4 py-3 border rounded-xl text-base focus:outline-none focus:ring-2 focus:ring-red-200">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</option>
              <option value="‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô">‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
              <option value="‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</option>
              <option value="‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥">‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</option>
              <option value="‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏°‡∏µ‡∏û‡∏¥‡∏© / ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢">‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏°‡∏µ‡∏û‡∏¥‡∏© / ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢</option>
              <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)</label>
            <textarea id="inputLocationNote" name="location_note" class="w-full px-4 py-3 border rounded-xl text-base focus:outline-none focus:ring-2 focus:ring-red-200" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ XYZ ‡πÉ‡∏Å‡∏•‡πâ‡∏ß‡∏±‡∏î..."></textarea>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</label>
            <div class="flex gap-3">
              <button type="button" id="getLocationBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-xl shadow">‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
              <div id="locationInfo" class="hidden bg-green-50 border border-green-200 rounded-xl p-3 text-sm text-green-800">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <span id="coordinates"></span></div>
            </div>
          </div>

          <div>
            <button id="submitBtn" type="submit" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white font-bold py-4 rounded-2xl text-lg shadow-xl">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
          </div>
        </form>
      </section>

      <!-- Quick Actions -->
      <section class="mt-4 grid grid-cols-2 gap-3">
        <button id="openTrackingBtn" class="bg-white rounded-xl p-3 shadow flex items-center justify-center space-x-2">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 6h18M3 14h18M3 18h18"></path></svg>
          <span class="text-sm font-medium">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
        </button>

        <button id="openMapBtn" class="bg-white rounded-xl p-3 shadow flex items-center justify-center space-x-2">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.567 3-3.5S13.657 4 12 4 9 5.567 9 7.5 10.343 11 12 11zM12 11v9"></path></svg>
          <span class="text-sm font-medium">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
        </button>
      </section>

    </main>

    <!-- Bottom Nav (Mobile App feel) -->
    <nav class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-[92%] bg-white rounded-2xl shadow-2xl p-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button class="text-sm text-gray-600">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        <button class="text-sm text-gray-600">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</button>
        <button class="text-sm text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
      </div>
      <div>
        <button id="fab" class="bg-red-600 text-white w-12 h-12 rounded-xl shadow-lg flex items-center justify-center">üìû</button>
      </div>
    </nav>

  </div>

  <div id="modalRoot"></div>

<script>
// --- Supabase Initialization ---
const supabaseUrl = "https://yoauscrafbucdahwlvmc.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvYXVzY3JhZmJ1Y2RhaHdsdm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzU4MzgsImV4cCI6MjA3ODk1MTgzOH0.GdoWeFsaEYEExSkqT92RiFqVHyKepjGV06ByeVmdDrQ";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// --- Audio alert setup ---
const ALERT_SOUND_URL = 'https://actions.google.com/sounds/v1/emergency/ambulance_siren.ogg';
const alertAudios = [new Audio(ALERT_SOUND_URL), new Audio(ALERT_SOUND_URL), new Audio(ALERT_SOUND_URL)];
alertAudios.forEach(a=>{ a.volume = 1.0; a.loop = true; a.preload = 'auto'; });
let reportsChannel = null;
let currentLocation = null;

function playAlertSound(){ alertAudios.forEach(a=>{ a.play().catch(()=>{}); }); }
function stopAlertSound(){ alertAudios.forEach(a=>{ try{ a.pause(); a.currentTime = 0; }catch(e){} }); }

function showToast(msg, type='success') {
  const div = document.createElement('div');
  div.className = `toast ${type}`;
  div.innerText = msg;
  document.body.appendChild(div);
  setTimeout(()=>div.classList.add('show'), 50);
  setTimeout(()=>{ div.classList.remove('show'); setTimeout(()=>div.remove(), 300); }, 3000);
}

function showModal(message) {
  const root = document.getElementById('modalRoot'); root.innerHTML = '';
  const overlay = document.createElement('div'); overlay.className = 'modal-overlay';
  overlay.innerHTML = `<div class="modal"><h3 class="text-lg font-bold mb-2">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3><p class="mb-4">${message}</p><div class="text-right"><button id="modalCloseBtn" class="px-3 py-1 rounded bg-red-600 text-white">‡∏õ‡∏¥‡∏î</button></div></div>`;
  root.appendChild(overlay);
  const closeBtn = document.getElementById('modalCloseBtn'); if (closeBtn) closeBtn.onclick = ()=> overlay.remove();
}

// Supabase CRUD helpers (same as before)
async function fetchReports({limit=null, phone=null}={}){
  let q = supabase.from('reports').select('*').order('created_at',{ascending:false});
  if (phone) q = q.eq('phone', phone);
  if (limit) q = q.limit(limit);
  const {data,error} = await q; if (error) { console.error('fetchReports', error); return []; } return data||[];
}
async function createReport(payload){ const {data,error} = await supabase.from('reports').insert(payload).select().single(); if (error) { console.error('createReport', error); throw error; } return data; }
async function updateReportStatus(id,status){ const {data,error} = await supabase.from('reports').update({status}).eq('id',id).select().single(); if (error) { console.error('updateReportStatus', error); throw error; } return data; }

function subscribeReportsRealtime(onEvent){ if (reportsChannel) return reportsChannel; reportsChannel = supabase.channel('public:reports').on('postgres_changes', {event:'*', schema:'public', table:'reports'}, payload=>{ try { onEvent && onEvent(payload); } catch(e){ console.error(e); } }).subscribe(); return reportsChannel; }
async function unsubscribeReportsRealtime(){ if (!reportsChannel) return; try{ await supabase.removeChannel(reportsChannel); }catch(e){console.warn(e);} reportsChannel=null; }

// Pending modal
function showPendingModal(pendingReports){ const root = document.getElementById('modalRoot'); const existing = document.getElementById('pendingAlertModal'); if (existing) existing.remove(); const overlay = document.createElement('div'); overlay.className = 'modal-overlay'; overlay.id = 'pendingAlertModal'; const listItems = pendingReports.map(r=>{ const lat=r.latitude||0; const lng=r.longitude||0; return `<div class="border p-2 rounded mb-2 bg-white"><div class="flex justify-between items-start"><div><div class="font-bold">${r.name||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}</div><div class="text-sm">üìû ${r.phone||''} ‚Ä¢ ${r.incident_type||''}</div><div class="text-xs text-gray-500">${r.created_at? new Date(r.created_at).toLocaleString('th-TH') : ''}</div></div><div class="text-right"><button class="open-map-btn underline text-blue-600 text-sm" data-lat="${lat}" data-lng="${lng}">‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button></div></div></div>`; }).join(''); overlay.innerHTML = `<div class="modal max-w-lg"><h3 class="text-lg font-bold mb-2">‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (${pendingReports.length})</h3><div style="max-height:300px; overflow:auto; margin-bottom:12px;">${listItems}</div><div class="text-right"><button id="dismissSoundBtn" class="px-3 py-1 rounded bg-gray-300 mr-2">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button><button id="closePendingModalBtn" class="px-3 py-1 rounded bg-red-600 text-white">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button></div></div>`; root.appendChild(overlay); overlay.querySelectorAll('.open-map-btn').forEach(btn=>{ btn.addEventListener('click', ()=>{ const lat = btn.getAttribute('data-lat'); const lng = btn.getAttribute('data-lng'); openGoogleMaps(lat, lng); }); }); const dismissBtn = document.getElementById('dismissSoundBtn'); const closeBtn = document.getElementById('closePendingModalBtn'); if (dismissBtn) dismissBtn.onclick = ()=>{ stopAlertSound(); }; if (closeBtn) closeBtn.onclick = ()=>{ overlay.remove(); }; }
function removePendingModal(){ const m = document.getElementById('pendingAlertModal'); if (m) m.remove(); }
async function checkPendingAndAlert(){ try{ const reports = await fetchReports(); const pending = reports.filter(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'); if (pending.length){ playAlertSound(); showPendingModal(pending); } else { stopAlertSound(); removePendingModal(); } }catch(e){ console.error('checkPendingAndAlert', e); } }

// Render admin list (kept but not visible in mobile UI unless logged in)
async function loadAndRenderReports(){ let reports = await fetchReports(); reports = reports.sort((a,b)=>{ if (a.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && b.status !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return -1; if (a.status !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && b.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return 1; return new Date(b.created_at) - new Date(a.created_at); }); const listEl = document.getElementById('reportsList'); if (!listEl) return; listEl.innerHTML = reports.map(r=>{ const highlight = r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'bg-yellow-100 border-yellow-400' : ''; const lat = r.latitude ?? 0; const lng = r.longitude ?? 0; return `<div class="border p-4 rounded ${highlight}"><div class="flex justify-between"><div><h3 class="font-bold">${r.name||''}</h3><p>üìû ${r.phone||''}</p><p>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${r.incident_type||''}</p><p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${r.location_note||'-'}</p><p class="text-xs text-gray-500">${r.created_at? new Date(r.created_at).toLocaleString('th-TH') : ''}</p><button onclick="openGoogleMaps(${lat},${lng})" class="text-blue-600 underline">‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button></div><div><select onchange="handleChangeStatus(${r.id}, this.value)" class="border rounded px-2 py-1"><option ${r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'?'selected':''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option><option ${r.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ'?'selected':''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ</option><option ${r.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'?'selected':''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option></select></div></div></div>`; }).join(''); await checkPendingAndAlert(); }

function openGoogleMaps(lat,lng){ window.open(`https://www.google.com/maps?q=${lat},${lng}`,'_blank'); }
async function handleChangeStatus(id,value){ try{ await updateReportStatus(id,value); showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß','success'); await loadAndRenderReports(); const reports = await fetchReports(); if (!reports.some(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')) stopAlertSound(); } catch(e){ showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }}

function startRealtimeIntegration(){ subscribeReportsRealtime(async payload=>{ console.log('realtime',payload); const evt = (payload.eventType||payload.event||'').toUpperCase(); const newRow = payload.new||null; const oldRow = payload.old||null; const becamePending = (evt==='INSERT' && newRow && newRow.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') || (evt==='UPDATE' && newRow && oldRow && newRow.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && oldRow.status!=='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'); if (becamePending){ showModal(`‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å: ${newRow.name||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}`); await checkPendingAndAlert(); } if (evt==='UPDATE' && oldRow && oldRow.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && newRow && newRow.status!=='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'){ const reports = await fetchReports(); if (!reports.some(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')) stopAlertSound(); } await loadAndRenderReports(); }); }

// Form handlers
function safeGet(id){ return document.getElementById(id); }
const getLocationBtn = safeGet('getLocationBtn');
if (getLocationBtn) getLocationBtn.onclick = ()=>{ const btn = getLocationBtn; btn.disabled=true; btn.innerHTML='<div class="loading mr-2"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...'; navigator.geolocation.getCurrentPosition(pos=>{ currentLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude }; const locInfo = safeGet('locationInfo'); const coords = safeGet('coordinates'); if (locInfo && coords){ locInfo.classList.remove('hidden'); coords.innerText = '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: '+currentLocation.latitude.toFixed(6)+', ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î: '+currentLocation.longitude.toFixed(6); } btn.innerText='‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'; btn.disabled=false; showToast('‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success'); }, err=>{ btn.innerText='‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'; btn.disabled=false; showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ','error'); }); };

const emergencyForm = safeGet('emergencyForm');
if (emergencyForm) emergencyForm.onsubmit = async (e)=>{ e.preventDefault(); const nameEl = safeGet('inputName'); const phoneEl = safeGet('inputPhone'); const typeEl = safeGet('inputType'); const name = nameEl ? nameEl.value.trim() : ''; const phone = phoneEl ? phoneEl.value.trim() : ''; const incident_type = typeEl ? typeEl.value : ''; if (!name||!phone||!incident_type) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error'); if (!currentLocation) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô','error'); const location_note = safeGet('inputLocationNote')?.value?.trim() || ''; const payload = { name, phone, incident_type, location_note, latitude: currentLocation.latitude, longitude: currentLocation.longitude, status: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' }; try{ await createReport(payload); showToast('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success'); if (emergencyForm) emergencyForm.reset(); currentLocation=null; const locInfo = safeGet('locationInfo'); if (locInfo) locInfo.classList.add('hidden'); }catch(e){ showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ','error'); } };

// tracking
const trackBtn = safeGet('trackBtn');
if (trackBtn) trackBtn.onclick = async ()=>{ const phoneEl = safeGet('trackPhone'); const phone = phoneEl ? phoneEl.value.trim() : ''; if (!phone) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£','error'); const { data, error } = await supabase.from('reports').select('*').eq('phone',phone).order('created_at',{ascending:false}); const container = safeGet('trackResults'); if (!container) return; if (error) { container.innerHTML = '<p class="text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>'; return; } if (!data.length) { container.innerHTML = '<p class="text-gray-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; return; } container.innerHTML = data.map(r=>`<div class='border p-4 rounded-lg bg-gray-50'><p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${r.status}</p><p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${r.location_note||'-'}</p><p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${r.incident_type}</p><p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${r.created_at? new Date(r.created_at).toLocaleString('th-TH') : ''}</p><button onclick="openGoogleMaps(${r.latitude||0},${r.longitude||0})" class="text-blue-600 underline">‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button></div>`).join(''); };

// navigation buttons
const openLoginBtn = safeGet('openLoginBtn'); if (openLoginBtn) openLoginBtn.onclick = ()=>{ safeGet('reportForm')?.classList.add('hidden'); safeGet('loginPage')?.classList.remove('hidden'); };
const openTrackingBtn = safeGet('openTrackingBtn'); if (openTrackingBtn) openTrackingBtn.onclick = ()=>{ safeGet('reportForm')?.classList.add('hidden'); safeGet('userTrackingPage')?.classList.remove('hidden'); };

// initial load
const reportForm = safeGet('reportForm'); if (reportForm) reportForm.classList.remove('hidden');

</script>

</body>
</html>
