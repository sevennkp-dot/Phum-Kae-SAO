<!-- Source file: sandbox:/mnt/data/3ok.txt -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û ‡∏≠‡∏ö‡∏ï.‡∏û‡∏∏‡πà‡∏°‡πÅ‡∏Å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { box-sizing: border-box; }
    .loading { display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #dc2626;border-radius:50%;animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
    .toast { position:fixed;top:20px;right:20px;padding:12px 24px;border-radius:8px;color:white;font-weight:500;z-index:1000;transform:translateX(120%);transition:transform .3s ease; }
    .toast.show { transform:translateX(0); }
    .toast.success { background-color:#10b981; }
    .toast.error { background-color:#ef4444; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:2000; }
    .modal { background:white; padding:18px; border-radius:10px; max-width:420px; width:92%; box-shadow:0 8px 24px rgba(0,0,0,0.2); }
  </style>
</head>
<body class="h-screen overflow-hidden bg-gradient-to-br from-red-50 to-orange-50">

<main class="h-screen overflow-y-auto container mx-auto px-4 py-6">

  <!-- Login Page -->
  <div id="loginPage" class="max-w-sm mx-auto mb-8 hidden">
    <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-200">
      <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h2>

      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
          <input type="text" name="username" required class="w-full px-4 py-3 border rounded-lg" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input type="password" name="password" required class="w-full px-4 py-3 border rounded-lg" />
        </div>

        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
    </div>
  </div>

  <!-- Report Form -->
  <div id="reportForm" class="max-w-2xl mx-auto">

    

    <!-- Tracking button -->
    

    <div class="bg-white rounded-2xl shadow-xl p-8 border border-red-100">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
        </div>
        <h1 class="text-3xl font-bold text-red-800 mb-2">‡∏≠‡∏ö‡∏ï.‡∏û‡∏∏‡πà‡∏°‡πÅ‡∏Å</h1>
        <p class="text-red-600 text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û</p>
      </div>

      <form id="emergencyForm" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
          <input id="inputName" type="text" name="name" required class="w-full px-4 py-3 border rounded-lg text-lg" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
          <input id="inputPhone" type="tel" name="phone" required class="w-full px-4 py-3 border rounded-lg text-lg" />
        </div>

        

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *</label>
          <select id="inputType" name="incident_type" required class="w-full px-4 py-3 border rounded-lg text-lg">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</option>
            <option value="‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô">‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
            <option value="‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</option>
            <option value="‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥">‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</option>
            <option value="‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏°‡∏µ‡∏û‡∏¥‡∏© / ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢">‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏°‡∏µ‡∏û‡∏¥‡∏© / ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)</label>
          <textarea id="inputLocationNote" name="location_note" class="w-full px-4 py-3 border rounded-lg text-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏ô‡∏ô‡∏à‡∏±‡∏ó‡∏£‡πå ‡∏´‡∏°‡∏π‡πà 8 ‡πÉ‡∏Å‡∏•‡πâ‡∏ß‡∏±‡∏î..."></textarea>
        </div>

        <div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ *</label>
          <div class="space-y-3">
            <button type="button" id="getLocationBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg">‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>

            <div id="locationInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
              <p class="text-green-800 text-sm font-medium">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</p>
              <p id="coordinates" class="text-green-700 text-sm"></p>
            </div>
          </div>
        </div>
       
        <button id="submitBtn" type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg text-lg">
          ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</button>

        <button id="openLoginBtn" type="button" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 rounded-lg text-lg">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</button>

        <button id="openTrackingBtn" type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg text-lg">
          ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</button>
        
      </form>
    </div>
  </div>

  <!-- Tracking Page -->
  <div id="userTrackingPage" class="hidden max-w-xl mx-auto">
    <div class="bg-white rounded-2xl shadow-xl p-6 border border-blue-200">
      <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h2>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</label>
        <input id="trackPhone" type="tel" class="w-full px-4 py-3 border rounded-lg" placeholder="0812345678" />
      </div>

      <button id="trackBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg mb-6">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>

      <div id="trackResults" class="space-y-4"></div>

      <button id="backToReportBtn" class="mt-6 underline text-gray-600">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="hidden">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h1>
        <button id="logoutBtn" class="bg-gray-500 text-white py-2 px-4 rounded-lg">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
      <h2 class="text-lg font-semibold text-gray-700 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      <div id="reportsList" class="space-y-4"></div>
    </div>
  </div>

</main>

<div id="modalRoot"></div>

<script>
// --- Supabase Initialization ---
const supabaseUrl = "https://yoauscrafbucdahwlvmc.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvYXVzY3JhZmJ1Y2RhaHdsdm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzU4MzgsImV4cCI6MjA3ODk1MTgzOH0.GdoWeFsaEYEExSkqT92RiFqVHyKepjGV06ByeVmdDrQ";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// --- Audio alert setup (single consistent API) ---
// We'll create multiple audio elements and manage them via an array to avoid accidental redefinitions
const ALERT_SOUND_URL = 'https://actions.google.com/sounds/v1/emergency/ambulance_siren.ogg';
const alertAudios = [new Audio(ALERT_SOUND_URL), new Audio(ALERT_SOUND_URL), new Audio(ALERT_SOUND_URL)];
alertAudios.forEach(a=>{ a.volume = 1.0; a.loop = true; a.preload = 'auto'; });
let reportsChannel = null;
let currentLocation = null;

function playAlertSound(){
  // attempt to play all audios; swallow promise errors (autoplay restrictions)
  alertAudios.forEach(a=>{ a.play().catch(()=>{}); });
}
function stopAlertSound(){
  alertAudios.forEach(a=>{ try{ a.pause(); a.currentTime = 0; }catch(e){} });
}

/* UI helpers */
function showToast(msg, type='success') {
  const div = document.createElement('div');
  div.className = `toast ${type}`;
  div.innerText = msg;
  document.body.appendChild(div);
  setTimeout(()=>div.classList.add('show'), 50);
  setTimeout(()=>{ div.classList.remove('show'); setTimeout(()=>div.remove(), 300); }, 3000);
}

function showModal(message) {
  const root = document.getElementById('modalRoot');
  // remove existing
  root.innerHTML = '';
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal">
      <h3 class="text-lg font-bold mb-2">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
      <p class="mb-4">${message}</p>
      <div class="text-right">
        <button id="modalCloseBtn" class="px-3 py-1 rounded bg-red-600 text-white">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  `;
  root.appendChild(overlay);
  const closeBtn = document.getElementById('modalCloseBtn');
  if (closeBtn) closeBtn.onclick = ()=> overlay.remove();
}

// --- CRUD / Supabase helpers ---
async function fetchReports({limit=null, phone=null}={}){
  let q = supabase.from('reports').select('*').order('created_at',{ascending:false});
  if (phone) q = q.eq('phone', phone);
  if (limit) q = q.limit(limit);
  const {data,error} = await q;
  if (error) { console.error('fetchReports', error); return []; }
  return data||[];
}

async function createReport(payload){
  const {data,error} = await supabase.from('reports').insert(payload).select().single();
  if (error) { console.error('createReport', error); throw error; }
  return data;
}

async function updateReportStatus(id,status){
  const {data,error} = await supabase.from('reports').update({status}).eq('id',id).select().single();
  if (error) { console.error('updateReportStatus', error); throw error; }
  return data;
}

// --- realtime ---
function subscribeReportsRealtime(onEvent){
  if (reportsChannel) return reportsChannel;
  reportsChannel = supabase
    .channel('public:reports')
    .on('postgres_changes', {event:'*', schema:'public', table:'reports'}, payload=>{
      try { onEvent && onEvent(payload); } catch(e){ console.error(e); }
    })
    .subscribe();
  return reportsChannel;
}
async function unsubscribeReportsRealtime(){ if (!reportsChannel) return; try{ await supabase.removeChannel(reportsChannel); }catch(e){console.warn(e);} reportsChannel=null; }

// --- Pending alert modal management ---
function showPendingModal(pendingReports){
  const root = document.getElementById('modalRoot');
  // remove existing pending modal only
  const existing = document.getElementById('pendingAlertModal');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'pendingAlertModal';

  const listItems = pendingReports.map(r=>{
    const lat = r.latitude||0; const lng = r.longitude||0;
    return `<div class="border p-2 rounded mb-2 bg-white">
      <div class="flex justify-between items-start">
        <div>
          <div class="font-bold">${r.name||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}</div>
          <div class="text-sm">üìû ${r.phone||''} ‚Ä¢ ${r.incident_type||''}</div>
          <div class="text-xs text-gray-500">${r.created_at? new Date(r.created_at).toLocaleString('th-TH') : ''}</div>
        </div>
        <div class="text-right">
          <button class="open-map-btn underline text-blue-600 text-sm" data-lat="${lat}" data-lng="${lng}">‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
        </div>
      </div>
    </div>`;
  }).join('');

  overlay.innerHTML = `
    <div class="modal max-w-lg">
      <h3 class="text-lg font-bold mb-2">‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (${pendingReports.length})</h3>
      <div style="max-height:300px; overflow:auto; margin-bottom:12px;">
        ${listItems}
      </div>
      <div class="text-right">
        <button id="dismissSoundBtn" class="px-3 py-1 rounded bg-gray-300 mr-2">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <button id="closePendingModalBtn" class="px-3 py-1 rounded bg-red-600 text-white">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
      </div>
    </div>
  `;

  root.appendChild(overlay);

  // attach handlers for dynamic map buttons
  overlay.querySelectorAll('.open-map-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const lat = btn.getAttribute('data-lat');
      const lng = btn.getAttribute('data-lng');
      openGoogleMaps(lat, lng);
    });
  });

  const dismissBtn = document.getElementById('dismissSoundBtn');
  const closeBtn = document.getElementById('closePendingModalBtn');
  if (dismissBtn) dismissBtn.onclick = ()=>{ stopAlertSound(); };
  if (closeBtn) closeBtn.onclick = ()=>{ overlay.remove(); };
}

function removePendingModal(){ const m = document.getElementById('pendingAlertModal'); if (m) m.remove(); }

// Check pending reports and ensure persistent alert + modal
async function checkPendingAndAlert(){
  try{
    const reports = await fetchReports();
    const pending = reports.filter(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
    if (pending.length){
      playAlertSound();
      showPendingModal(pending);
    } else {
      stopAlertSound();
      removePendingModal();
    }
  }catch(e){ console.error('checkPendingAndAlert', e); }
}

// --- render functions ---
async function loadAndRenderReports(){
  let reports = await fetchReports();
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î
  reports = reports.sort((a,b)=>{
    if (a.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && b.status !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return -1;
    if (a.status !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && b.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return 1;
    return new Date(b.created_at) - new Date(a.created_at);
  });
  const listEl = document.getElementById('reportsList');
  if (!listEl) return;
  listEl.innerHTML = reports.map(r=>{
    const highlight = r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'bg-yellow-100 border-yellow-400' : '';
    const lat = r.latitude ?? 0;
    const lng = r.longitude ?? 0;
    return `
      <div class="border p-4 rounded ${highlight}">
        <div class="flex justify-between">
          <div>
            <h3 class="font-bold">${r.name||''}</h3>
            <p>üìû ${r.phone||''}</p>
            <p>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${r.incident_type||''}</p>
            <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${r.location_note||'-'}</p>
            <p class="text-xs text-gray-500">${r.created_at? new Date(r.created_at).toLocaleString('th-TH') : ''}</p>
            <button onclick="openGoogleMaps(${lat},${lng})" class="text-blue-600 underline">‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
          </div>
          <div>
            <select onchange="handleChangeStatus(${r.id}, this.value)" class="border rounded px-2 py-1">
              <option ${r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'?'selected':''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option ${r.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ'?'selected':''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ</option>
              <option ${r.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'?'selected':''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
            </select>
          </div>
        </div>
      </div>`;
  }).join('');

  // Ensure persistent alert/modal state reflects current data
  await checkPendingAndAlert();
}

function openGoogleMaps(lat,lng){ window.open(`https://www.google.com/maps?q=${lat},${lng}`,'_blank'); }

async function handleChangeStatus(id,value){ try{ await updateReportStatus(id,value); showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß','success'); await loadAndRenderReports(); // stop alert if none pending
    const reports = await fetchReports(); if (!reports.some(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')) stopAlertSound(); } catch(e){ showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }}

// --- start realtime integration (play sound + modal for new pending) ---
function startRealtimeIntegration(){
  subscribeReportsRealtime(async payload=>{
    console.log('realtime',payload);
    const evt = (payload.eventType||payload.event||'').toUpperCase();
    const newRow = payload.new||null; const oldRow = payload.old||null;
    const becamePending = (evt==='INSERT' && newRow && newRow.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') || (evt==='UPDATE' && newRow && oldRow && newRow.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && oldRow.status!=='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
    if (becamePending){
      // show a quick modal for the new row (full pending list handled elsewhere)
      showModal(`‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å: ${newRow.name||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}`);
      // then sync the persistent modal + sound
      await checkPendingAndAlert();
    }
    if (evt==='UPDATE' && oldRow && oldRow.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && newRow && newRow.status!=='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'){
      const reports = await fetchReports(); if (!reports.some(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')) stopAlertSound(); }
    await loadAndRenderReports();
  });
}

// --- form handlers ---
function safeGet(id){ return document.getElementById(id); }
const getLocationBtn = safeGet('getLocationBtn');
if (getLocationBtn) getLocationBtn.onclick = ()=>{
  const btn = getLocationBtn; btn.disabled=true; btn.innerHTML='<div class="loading mr-2"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
    const locInfo = safeGet('locationInfo');
    const coords = safeGet('coordinates');
    if (locInfo && coords){
      locInfo.classList.remove('hidden');
      coords.innerText = '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: '+currentLocation.latitude.toFixed(6)+', ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î: '+currentLocation.longitude.toFixed(6);
    }
    btn.innerText='‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'; btn.disabled=false; showToast('‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success');
  }, err=>{ btn.innerText='‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'; btn.disabled=false; showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ','error'); });
};

const emergencyForm = safeGet('emergencyForm');
if (emergencyForm) emergencyForm.onsubmit = async (e)=>{
  e.preventDefault();
  const nameEl = safeGet('inputName');
  const phoneEl = safeGet('inputPhone');
  const typeEl = safeGet('inputType');
  const name = nameEl ? nameEl.value.trim() : '';
  const phone = phoneEl ? phoneEl.value.trim() : '';
  const incident_type = typeEl ? typeEl.value : '';
  if (!name||!phone||!incident_type) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error');
  if (!currentLocation) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô','error');
  const location_note = safeGet('inputLocationNote')?.value?.trim() || '';
  const payload = { name, phone, incident_type, location_note, latitude: currentLocation.latitude, longitude: currentLocation.longitude, status: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' };
  try{
    await createReport(payload);
    showToast('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
    if (emergencyForm) emergencyForm.reset(); currentLocation=null; const locInfo = safeGet('locationInfo'); if (locInfo) locInfo.classList.add('hidden');
  }catch(e){ showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ','error'); }
};

// tracking
const trackBtn = safeGet('trackBtn');
if (trackBtn) trackBtn.onclick = async ()=>{
  const phoneEl = safeGet('trackPhone');
  const phone = phoneEl ? phoneEl.value.trim() : '';
  if (!phone) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£','error');
  const { data, error } = await supabase.from('reports').select('*').eq('phone',phone).order('created_at',{ascending:false});
  const container = safeGet('trackResults');
  if (!container) return;
  if (error) { container.innerHTML = '<p class="text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>'; return; }
  if (!data.length) { container.innerHTML = '<p class="text-gray-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; return; }
  container.innerHTML = data.map(r=>`
    <div class='border p-4 rounded-lg bg-gray-50'>
      <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${r.status}</p>
      <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${r.location_note||'-'}</p>
      <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${r.incident_type}</p>
      <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${r.created_at? new Date(r.created_at).toLocaleString('th-TH') : ''}</p>
      <button onclick="openGoogleMaps(${r.latitude||0},${r.longitude||0})" class="text-blue-600 underline">‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
    </div>`).join('');
};

// navigation buttons
const openLoginBtn = safeGet('openLoginBtn'); if (openLoginBtn) openLoginBtn.onclick = ()=>{ safeGet('reportForm').classList.add('hidden'); safeGet('loginPage').classList.remove('hidden'); };
const openTrackingBtn = safeGet('openTrackingBtn'); if (openTrackingBtn) openTrackingBtn.onclick = ()=>{ safeGet('reportForm').classList.add('hidden'); safeGet('userTrackingPage').classList.remove('hidden'); };
const backToReportBtn = safeGet('backToReportBtn'); if (backToReportBtn) backToReportBtn.onclick = ()=>{ safeGet('userTrackingPage').classList.add('hidden'); safeGet('reportForm').classList.remove('hidden'); };

// login form
const loginForm = safeGet('loginForm');
if (loginForm) loginForm.onsubmit = (e)=>{
  e.preventDefault();
  const f = new FormData(e.target); const user = f.get('username'); const pass = f.get('password');
  if (user==='admin' && pass==='admin123'){
    safeGet('loginPage').classList.add('hidden'); safeGet('adminDashboard').classList.remove('hidden');
    loadAndRenderReports(); startRealtimeIntegration();
    // try to unlock audio (play/pause) using alertAudios array
    alertAudios.forEach(a=>{ a.muted=true; a.play().then(()=>{ a.pause(); a.currentTime=0; a.muted=false; }).catch(()=>{ a.muted=false; }); });
    showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
  }else showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');
};

// logout
const logoutBtn = safeGet('logoutBtn'); if (logoutBtn) logoutBtn.onclick = async ()=>{
  safeGet('adminDashboard').classList.add('hidden'); safeGet('reportForm').classList.remove('hidden');
  await unsubscribeReportsRealtime(); stopAlertSound(); removePendingModal(); showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß','success');
};

// initial load (report form visible)
const reportForm = safeGet('reportForm'); if (reportForm) reportForm.classList.remove('hidden');

</script>

</body>
</html>
