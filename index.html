<!-- Original file: /mnt/data/3ok.txt -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û ‚Äî ‡∏≠‡∏ö‡∏ï.‡∏û‡∏∏‡πà‡∏°‡πÅ‡∏Å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#f8fafc;--primary:#dc2626;--accent:#1d4ed8;}
    html,body{height:100%;}
    body{background:linear-gradient(180deg,#f8fafc 0%, #fff 100%);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial;}
    .loading{display:inline-block;width:18px;height:18px;border:3px solid #f3f3f3;border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(-10px);top:18px;z-index:60;padding:10px 16px;border-radius:10px;color:white;font-weight:600;opacity:0;transition:all .28s ease;backdrop-filter: blur(4px)}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    /* highlight animation for new items */
    .pulse-highlight{animation:pulse 2s ease-in-out; border-color:#fde68a}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(253,230,138,0.0)}50%{box-shadow:0 6px 18px -6px rgba(253,230,138,0.6)}100%{box-shadow:0 0 0 0 rgba(253,230,138,0.0)}}
  </style>
</head>
<body class="min-h-screen text-gray-800">

  <main class="max-w-2xl mx-auto p-4">

    <!-- Top header / brand -->
    <header class="mt-6 mb-6 flex items-center gap-3">
      <div class="w-14 h-14 rounded-2xl bg-[var(--primary)] flex items-center justify-center shadow-md">
        <!-- simple ambulance icon -->
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M3 13.5V6a2 2 0 012-2h14a2 2 0 012 2v7.5M7 21h1.5M15.5 21H17M7 13.5h10M7 9h10"/></svg>
      </div>
      <div>
        <h1 class="text-xl font-extrabold">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û</h1>
        <p class="text-sm text-gray-600">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏• ‡∏û‡∏∏‡πà‡∏°‡πÅ‡∏Å</p>
      </div>
    </header>

    <!-- Primary card: emergency form -->
    <section id="reportCard" class="bg-white rounded-2xl shadow-lg border border-gray-100 p-5 mb-5">

      <div class="mb-4">
        <h2 class="text-lg font-bold">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h2>
        <p class="text-sm text-gray-600 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
      </div>

      <form id="emergencyForm" class="space-y-4" novalidate>

        <div>
          <label for="inputName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-600">*</span></label>
          <input id="inputName" name="name" type="text" required class="mt-1 block w-full rounded-xl border px-4 py-3 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
        </div>

        <div>
          <label for="inputPhone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-600">*</span></label>
          <input id="inputPhone" name="phone" type="tel" inputmode="tel" pattern="[0-9+()\s-]{6,}" required class="mt-1 block w-full rounded-xl border px-4 py-3 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" placeholder="08x-xxx-xxxx">
        </div>

        <div>
          <label for="inputType" class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå <span class="text-red-600">*</span></label>
          <select id="inputType" name="incident_type" required class="mt-1 block w-full rounded-xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå --</option>
            <option>‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
            <option>‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</option>
            <option>‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</option>
            <option>‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏°‡∏µ‡∏û‡∏¥‡∏© / ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢</option>
            <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>

        <div>
          <label for="inputLocationNote" class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <textarea id="inputLocationNote" name="location_note" rows="2" class="mt-1 block w-full rounded-xl border px-4 py-3 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 12 ‡∏´‡∏°‡∏π‡πà 5 ‡πÉ‡∏Å‡∏•‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü"></textarea>
        </div>

        <!-- Location picker -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <span class="text-red-600">*</span></label>

          <div class="flex gap-3">
            <button id="getLocationBtn" type="button" class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-[var(--accent)] hover:bg-blue-800 text-white font-semibold focus:outline-none focus:ring-2 focus:ring-blue-300">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v2m6.364 1.636l-1.414 1.414M20 12h-2M18.364 18.364l-1.414-1.414M12 20v-2M5.636 18.364l1.414-1.414M4 12h2M5.636 5.636l1.414 1.414"/></svg>
              ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            </button>

            <button id="manualPlaceBtn" type="button" class="flex-initial inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-gray-100 border border-gray-200 text-gray-700 hover:bg-gray-50 focus:outline-none">
              ‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠
            </button>
          </div>

          <div id="locationInfo" class="mt-2 hidden text-sm text-gray-700 bg-green-50 border border-green-100 rounded-lg p-3">
            <div id="coordinates" class="font-medium"></div>
            <div id="geoText" class="text-xs text-gray-600 mt-1"></div>
          </div>
        </div>

        <div class="space-y-2">
          <button id="submitBtn" type="submit" class="w-full py-3 rounded-xl bg-[var(--primary)] hover:bg-red-700 text-white font-extrabold text-lg shadow">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</button>

          <div class="grid grid-cols-2 gap-3">
            <button id="openTrackingBtn" type="button" class="w-full py-3 rounded-xl bg-white border border-gray-200 text-gray-700 font-semibold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
            <button id="openLoginBtn" type="button" class="w-full py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-semibold">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
          </div>
        </div>

      </form>

    </section>

    <!-- Tracking (hidden by default) -->
    <section id="userTrackingPage" class="hidden bg-white rounded-2xl shadow-lg border border-gray-100 p-5 mb-5">
      <div class="mb-3"><h3 class="font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h3><p class="text-sm text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</p></div>
      <div class="space-y-3">
        <input id="trackPhone" type="tel" class="w-full rounded-xl border px-4 py-3" placeholder="08x-xxx-xxxx">
        <button id="trackBtn" class="w-full py-3 rounded-xl bg-[var(--accent)] hover:bg-blue-800 text-white font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <div id="trackResults" class="space-y-3"></div>
        <button id="backToReportBtn" class="text-sm text-gray-600 underline">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
    </section>

    <!-- Admin (login + dashboard) -->
    <section id="loginPage" class="hidden bg-white rounded-2xl shadow-lg border border-gray-100 p-5 mb-5">
      <h3 class="font-bold mb-3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>
      <form id="loginForm" class="space-y-3">
        <input name="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full rounded-xl border px-4 py-3" required>
        <input name="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full rounded-xl border px-4 py-3" required>
        <button class="w-full py-3 rounded-xl bg-gray-800 text-white font-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
    </section>

    <section id="adminDashboard" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î ‚Äî ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</h3>
        <div class="flex gap-2">
          <button id="refreshReports" class="px-3 py-2 rounded-lg bg-gray-100">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button id="enableSoundBtn" class="px-3 py-2 rounded-lg bg-blue-600 text-white">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
          <button id="logoutBtn" class="px-3 py-2 rounded-lg bg-gray-700 text-white">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>

      <div id="reportsList" class="space-y-3"></div>
    </section>

  </main>

  <div id="modalRoot"></div>
  <div id="toast" class="toast bg-black/80 rounded-lg"></div>

<script>
// ---------------------------
// Supabase (same as original)
// ---------------------------
const supabaseUrl = "https://yoauscrafbucdahwlvmc.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvYXVzY3JhZmJ1Y2RhaHdsdm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzU4MzgsImV4cCI6MjA3ODk1MTgzOH0.GdoWeFsaEYEExSkqT92RiFqVHyKepjGV06ByeVmdDrQ";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// --- small UI helpers ---
function toast(message, type='info'){
  const t = document.getElementById('toast'); t.innerText = message;
  t.className = 'toast ' + (type==='error'? 'bg-red-600' : type==='success'? 'bg-green-600' : 'bg-black/80');
  t.classList.add('show'); clearTimeout(t._h); t._h = setTimeout(()=>{ t.classList.remove('show'); }, 2500);
}

// --- Alert sound + pending modal (urgent notifications) ---
// Robust alert audio: crossOrigin, WebAudio amplification, explicit user enable button, and oscillator fallback
const ALERT_SOUND_URL = 'https://actions.google.com/sounds/v1/emergency/ambulance_siren.ogg';
const alertAudio = new Audio(ALERT_SOUND_URL);
alertAudio.loop = true; alertAudio.preload = 'auto';
alertAudio.crossOrigin = 'anonymous';

// Web Audio nodes
let audioCtx = null;
let alertSource = null;
let alertGain = null;
let oscillatorNode = null; // fallback if media element can't play
let initialGain = 2.0; // amplification factor (1.0 = unchanged)
let audioEnabled = false; // set true after user enables sound

function setupAlertAudio(){
  if(audioCtx || !alertAudio) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // create source from media element; may throw if not allowed cross-origin
    try{
      alertSource = audioCtx.createMediaElementSource(alertAudio);
      alertGain = audioCtx.createGain();
      alertGain.gain.value = initialGain;
      alertSource.connect(alertGain).connect(audioCtx.destination);
    }catch(e){
      console.warn('MediaElementSource failed, will use oscillator fallback', e);
      alertSource = null; alertGain = null;
    }

    // ensure resume on user interaction
    if(audioCtx.state === 'suspended'){
      const resume = ()=>{ audioCtx.resume().catch(()=>{}); document.removeEventListener('click', resume); };
      document.addEventListener('click', resume, { once: true });
    }
  }catch(e){
    console.warn('WebAudio setup failed', e);
    audioCtx = null; alertSource = null; alertGain = null;
  }
}

function enableAudioForUser(){
  // call this from a user gesture (button click) to allow autoplay/resume
  try{
    setupAlertAudio();
    if(audioCtx){ audioCtx.resume().catch(()=>{}); }
    // play a very short silent sound to unlock audio
    alertAudio.volume = 0.0001;
    alertAudio.play().then(()=>{
      alertAudio.pause(); alertAudio.currentTime = 0; alertAudio.volume = 1.0;
      audioEnabled = true; toast('‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success');
    }).catch(err=>{
      console.warn('unlock play failed', err);
      // try oscillator as a last resort
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        oscillatorNode = audioCtx.createOscillator();
        const g = audioCtx.createGain(); g.gain.value = 0.0001; // almost silent pulse to unlock
        oscillatorNode.connect(g).connect(audioCtx.destination);
        oscillatorNode.start(); setTimeout(()=>{ oscillatorNode.stop(); oscillatorNode.disconnect(); oscillatorNode=null; }, 100);
        audioEnabled = true; toast('‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success');
      }catch(e){ console.warn('oscillator unlock failed', e); toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'error'); }
    });
  }catch(e){ console.warn('enableAudioForUser failed', e); toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ', 'error'); }
}

function setAlertGain(value){
  initialGain = Number(value) || 1.0;
  try{ if(alertGain) alertGain.gain.value = initialGain; }catch(e){}
}

function startOscillatorFallback(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(oscillatorNode) return; // already running
    oscillatorNode = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    g.gain.value = 0.1; // moderate volume fallback
    oscillatorNode.type = 'sine';
    oscillatorNode.frequency.value = 880; // high-pitched alert-like tone
    oscillatorNode.connect(g).connect(audioCtx.destination);
    oscillatorNode.start();
  }catch(e){ console.warn('startOscillatorFallback failed', e); }
}

function stopOscillatorFallback(){
  try{ if(oscillatorNode){ oscillatorNode.stop(); oscillatorNode.disconnect(); oscillatorNode=null; } }catch(e){}
}

function playAlertSound(){
  try{
    if(!audioEnabled){
      // try to auto-enable by prompting user visually
      console.warn('audio not enabled; calling enableAudioForUser automatically');
      // show a temporary prompt (non-blocking)
      toast('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (required)', 'info');
      return;
    }
    setupAlertAudio();
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    if(alertSource){
      alertGain && (alertGain.gain.value = initialGain);
      alertAudio.volume = 1.0;
      alertAudio.play().catch(err=>{ console.warn('alertAudio play failed, starting oscillator fallback', err); startOscillatorFallback(); });
    } else {
      // media element source not available -> oscillator fallback
      startOscillatorFallback();
    }
  }catch(e){ console.warn('playAlertSound failed', e); }
}
function stopAlertSound(){
  try{
    if(alertAudio){ alertAudio.pause(); alertAudio.currentTime = 0; }
    stopOscillatorFallback();
  }catch(e){}
}

function showPendingModal(pendingReports){
  removePendingModal();
  if(!pendingReports || !pendingReports.length) return;
  const root = document.getElementById('modalRoot');
  const overlay = document.createElement('div');
  overlay.id = 'pendingAlertModal';
  overlay.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4';
  overlay.innerHTML = `
    <div class="bg-white rounded-xl p-4 max-w-xl w-full shadow-lg">
      <div class="flex items-start gap-3">
        <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-red-600 text-white font-bold">!</div>
        <div class="flex-1">
          <h3 class="font-bold text-lg">‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (${pendingReports.length})</h3>
          <p class="text-sm text-gray-600 mt-1">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡∏î‡πà‡∏ß‡∏ô</p>
          <div class="mt-3 space-y-2" style="max-height:220px; overflow:auto;">
            ${pendingReports.map(r=>`<div class="p-2 border rounded-md bg-gray-50">
              <div class="font-semibold">${r.name||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}</div>
              <div class="text-xs text-gray-600">${r.incident_type||''} ‚Ä¢ ${r.phone||''}</div>
              <div class="text-xs text-gray-500 mt-1">${r.location_note||''}</div>
              <div class="text-xs text-gray-400">${r.created_at? new Date(r.created_at).toLocaleString('th-TH') : ''}</div>
              <div class="text-right mt-2"><button class="open-map-btn underline text-blue-600 text-sm" data-lat="${r.latitude||0}" data-lng="${r.longitude||0}">‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button></div>
            </div>`).join('')}
          </div>
        </div>
      </div>
      <div class="mt-4 text-right">
        <button id="dismissAlertBtn" class="px-3 py-2 rounded-md bg-gray-100 mr-2">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <button id="closePendingModalBtn" class="px-3 py-2 rounded-md bg-red-600 text-white">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
      </div>
    </div>
  `;
  root.appendChild(overlay);
  overlay.querySelectorAll('.open-map-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ const lat=btn.dataset.lat; const lng=btn.dataset.lng; window.open(`https://www.google.com/maps?q=${lat},${lng}`,'_blank'); });
  });
  document.getElementById('dismissAlertBtn').addEventListener('click', ()=>{ stopAlertSound(); });
  document.getElementById('closePendingModalBtn').addEventListener('click', ()=>{ removePendingModal(); stopAlertSound(); });
}
function removePendingModal(){ const ex = document.getElementById('pendingAlertModal'); if(ex) ex.remove(); }

// --- geolocation state ---
let currentLocation = null;

// try to make mobile friendly prompt
const getLocationBtn = document.getElementById('getLocationBtn');
if(getLocationBtn) getLocationBtn.addEventListener('click', ()=>{
  getLocationBtn.disabled = true; const old = getLocationBtn.innerHTML; getLocationBtn.innerHTML = '<span class="loading"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
    document.getElementById('locationInfo').classList.remove('hidden');
    document.getElementById('coordinates').innerText = `‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: ${currentLocation.latitude.toFixed(6)}, ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î: ${currentLocation.longitude.toFixed(6)}`;
    document.getElementById('geoText').innerText = '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏';
    getLocationBtn.innerHTML = old; getLocationBtn.disabled = false; toast('‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
  }, err=>{
    getLocationBtn.disabled = false; getLocationBtn.innerHTML = old; toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà','error');
  }, { enableHighAccuracy:true, timeout:10000 });
});

// manual place toggling (simplified)
const manualPlaceBtn = document.getElementById('manualPlaceBtn');
if(manualPlaceBtn) manualPlaceBtn.addEventListener('click', ()=>{
  const note = document.getElementById('inputLocationNote'); note.focus(); note.scrollIntoView({behavior:'smooth', block:'center'});
});

// --- CRUD helpers ---
async function createReport(payload){
  try{
    const resp = await supabase.from('reports').insert(payload).select();
    if(resp.error){ console.error('createReport error (resp.error):', resp.error); throw resp.error; }
    const data = resp.data || resp;
    return Array.isArray(data) && data.length ? data[0] : data;
  }catch(e){ console.error('createReport exception:', e); const msg = e?.message || JSON.stringify(e); const err = new Error(msg); err.raw = e; throw err; }
}
async function fetchReports({ phone=null }={}){
  let q = supabase.from('reports').select('*').order('created_at',{ascending:false});
  if(phone) q = q.eq('phone', phone);
  const { data, error } = await q;
  if(error) { console.error(error); return []; }
  return data || [];
}
async function updateReportStatus(id, status){
  const { data, error } = await supabase.from('reports').update({ status }).eq('id', id).select().single();
  if(error) throw error; return data;
}

// --- form submit ---
const emergencyForm = document.getElementById('emergencyForm');
if(emergencyForm) emergencyForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = (document.getElementById('inputName')||{}).value?.trim();
  const phone = (document.getElementById('inputPhone')||{}).value?.trim();
  const incident_type = (document.getElementById('inputType')||{}).value;
  const note = (document.getElementById('inputLocationNote')||{}).value?.trim() || '';
  if(!name || !phone || !incident_type) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ * ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error');
  if(!currentLocation) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏','error');

  const payload = { name, phone, incident_type, location_note: note, latitude: currentLocation.latitude, longitude: currentLocation.longitude, status: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' };
  try{
    const resp = await createReport(payload);
    console.log('createReport response:', resp);
    emergencyForm.reset(); currentLocation = null; document.getElementById('locationInfo').classList.add('hidden');
    toast('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß','success');
  }catch(err){ console.error('submit error:', err, err?.raw || 'no raw'); const short = err?.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + short, 'error'); }
});

// --- tracking ---
const openTrackingBtn = document.getElementById('openTrackingBtn');
const backToReportBtn = document.getElementById('backToReportBtn');
if(openTrackingBtn) openTrackingBtn.addEventListener('click', ()=>{
  document.getElementById('reportCard').classList.add('hidden');
  document.getElementById('userTrackingPage').classList.remove('hidden');
});
if(backToReportBtn) backToReportBtn.addEventListener('click', ()=>{
  document.getElementById('userTrackingPage').classList.add('hidden');
  document.getElementById('reportCard').classList.remove('hidden');
});

const trackBtn = document.getElementById('trackBtn');
if(trackBtn) trackBtn.addEventListener('click', async ()=>{
  const phone = (document.getElementById('trackPhone')||{}).value?.trim();
  if(!phone) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£','error');
  const data = await fetchReports({ phone });
  const container = document.getElementById('trackResults'); container.innerHTML = '';
  if(!data.length) { container.innerHTML = '<div class="text-gray-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }
  container.innerHTML = data.map(r=>{
    return `<div class="p-3 rounded-xl border bg-gray-50">
      <div class="flex justify-between items-start">
        <div>
          <div class="font-semibold text-gray-800">${r.incident_type}</div>
          <div class="text-sm text-gray-600 mt-1">${r.location_note||'-'}</div>
          <div class="text-xs text-gray-500 mt-2">${r.created_at? new Date(r.created_at).toLocaleString('th-TH') : ''}</div>
        </div>
        <div class="text-right">
          <div class="text-sm font-semibold ${r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'? 'text-yellow-700' : r.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ'? 'text-blue-700' : 'text-green-700'}">${r.status}</div>
          <button onclick="window.open('https://www.google.com/maps?q=${r.latitude||0},${r.longitude||0}','_blank')" class="text-sm underline mt-2">‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
        </div>
      </div>
    </div>`;
  }).join('');
});

// --- Admin login + dashboard hooks (minimal) ---
const openLoginBtn = document.getElementById('openLoginBtn');
if(openLoginBtn) openLoginBtn.addEventListener('click', ()=>{
  document.getElementById('reportCard').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
});
const loginForm = document.getElementById('loginForm');
if(loginForm) loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(loginForm);
  const email = fd.get('email'); const password = fd.get('password');
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) { toast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('adminDashboard').classList.remove('hidden');
  await loadAndRenderReports();
  startRealtimeIntegration();
  toast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
});

// logout
const logoutBtn = document.getElementById('logoutBtn');
if(logoutBtn) logoutBtn.addEventListener('click', async ()=>{
  document.getElementById('adminDashboard').classList.add('hidden');
  document.getElementById('reportCard').classList.remove('hidden');
  try{ await unsubscribeReportsRealtime(); }catch(e){}
  toast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß','success');
});

// enable sound button (must be user gesture)
const enableSoundBtn = document.getElementById('enableSoundBtn');
if(enableSoundBtn) enableSoundBtn.addEventListener('click', ()=>{ enableAudioForUser(); });

// --- Realtime subscriptions (admin) ---
let reportsChannel = null;

function subscribeReportsRealtime(onEvent){
  if(reportsChannel) return reportsChannel;
  reportsChannel = supabase
    .channel('public:reports')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'reports' }, payload => {
      try{ onEvent && onEvent(payload); }catch(e){ console.error('realtime handler', e); }
    })
    .subscribe();
  return reportsChannel;
}

async function unsubscribeReportsRealtime(){
  if(!reportsChannel) return;
  try{ await supabase.removeChannel(reportsChannel); }catch(e){ console.warn('removeChannel failed', e); }
  reportsChannel = null;
}

function prependOrUpdateReportInList(row){
  try{
    const listEl = document.getElementById('reportsList'); if(!listEl) return;
    const existing = listEl.querySelector(`[data-id=report-${row.id}]`);
    const date = row.created_at ? new Date(row.created_at).toLocaleString('th-TH') : '';
    const html = `
      <div class="p-3 rounded-xl border flex justify-between items-start bg-white" data-id="report-${row.id}">
        <div>
          <div class="font-bold">${row.name||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}</div>
          <div class="text-sm text-gray-600">üìû ${row.phone || '-'}</div>
          <div class="text-sm text-gray-700 mt-1">${row.incident_type || '-'}</div>
          <div class="text-xs text-gray-500 mt-2">${date}</div>
          <div class="mt-2 text-sm text-gray-600">${row.location_note || '-'}</div>
        </div>
        <div class="flex flex-col items-end gap-2">
          <select onchange="handleChangeStatus(${row.id}, this.value)" class="px-2 py-1 rounded-lg border">
            <option ${row.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option ${row.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ'? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ</option>
            <option ${row.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
          </select>
          <button onclick="window.open('https://www.google.com/maps?q=${row.latitude||0},${row.longitude||0}','_blank')" class="text-sm underline">‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        </div>
      </div>`;
    if(existing){
      existing.outerHTML = html;
      // re-select element
      const sel = listEl.querySelector(`[data-id=report-${row.id}]`);
      if(sel){ sel.classList.add('pulse-highlight'); setTimeout(()=>sel.classList.remove('pulse-highlight'), 2200); }
    } else {
      listEl.insertAdjacentHTML('afterbegin', html);
      const sel = listEl.querySelector(`[data-id=report-${row.id}]`);
      if(sel){ sel.classList.add('pulse-highlight'); setTimeout(()=>sel.classList.remove('pulse-highlight'), 2200); sel.scrollIntoView({behavior:'smooth', block:'start'}); }
    }
  }catch(e){ console.error('prependOrUpdateReportInList', e); }
}

function startRealtimeIntegration(){
  subscribeReportsRealtime(async payload => {
    try{
      const evt = (payload.eventType || payload.event || '').toUpperCase();
      const newRow = payload.new || null; const oldRow = payload.old || null;
      if(evt === 'INSERT' && newRow){
        prependOrUpdateReportInList(newRow);
        // urgent: if pending, play sound & open modal
        if(newRow.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'){
          playAlertSound();
          const reports = await fetchReports();
          const pending = reports.filter(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
          showPendingModal(pending);
        }
        toast('‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡∏°‡πà', 'info');
      } else if(evt === 'UPDATE' && newRow){
        prependOrUpdateReportInList(newRow);
        // if became pending
        if(oldRow && oldRow.status !== newRow.status && newRow.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'){
          playAlertSound();
          const reports = await fetchReports();
          const pending = reports.filter(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
          showPendingModal(pending);
        }
        // if pending count went to zero, stop sound
        if(oldRow && oldRow.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && newRow.status !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'){
          const reports = await fetchReports();
          if(!reports.some(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')){ stopAlertSound(); removePendingModal(); }
        }
        if(oldRow && oldRow.status !== newRow.status){ toast('‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'info'); }
      } else if(evt === 'DELETE' && oldRow){
        const listEl = document.getElementById('reportsList'); const el = listEl.querySelector(`[data-id=report-${oldRow.id}]`); if(el) el.remove();
        const reports = await fetchReports(); if(!reports.some(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')){ stopAlertSound(); removePendingModal(); }
        toast('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö', 'info');
      }
    }catch(e){ console.error('realtime payload error', e); }
  });
}

// --- Reports rendering for admin ---
async function loadAndRenderReports(){
  const list = document.getElementById('reportsList'); list.innerHTML = '<div class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
  let reports = await fetchReports();
  if(!reports.length) { list.innerHTML = '<div class="text-gray-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</div>'; return; }
  // sort: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô, ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  reports = reports.sort((a,b)=>{
    if(a.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && b.status !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return -1;
    if(a.status !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && b.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return 1;
    return new Date(b.created_at) - new Date(a.created_at);
  });
  list.innerHTML = reports.map(r=>{
    const date = r.created_at ? new Date(r.created_at).toLocaleString('th-TH') : '';
    return `<div class="p-3 rounded-xl border flex justify-between items-start bg-white" data-id="report-${r.id}">
      <div>
        <div class="font-bold">${r.name||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}</div>
        <div class="text-sm text-gray-600">üìû ${r.phone || '-'}</div>
        <div class="text-sm text-gray-700 mt-1">${r.incident_type || '-'}</div>
        <div class="text-xs text-gray-500 mt-2">${date}</div>
        <div class="mt-2 text-sm text-gray-600">${r.location_note || '-'}</div>
      </div>
      <div class="flex flex-col items-end gap-2">
        <select onchange="handleChangeStatus(${r.id}, this.value)" class="px-2 py-1 rounded-lg border">
          <option ${r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option ${r.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ'? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ</option>
          <option ${r.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
        </select>
        <button onclick="window.open('https://www.google.com/maps?q=${r.latitude||0},${r.longitude||0}','_blank')" class="text-sm underline">‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
      </div>
    </div>`;
  }).join('');

  // if any pending -> show modal + play sound
  const pending = reports.filter(r=>r.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
  if(pending.length){ playAlertSound(); showPendingModal(pending); } else { stopAlertSound(); removePendingModal(); }
}

async function handleChangeStatus(id, value){
  try{ await updateReportStatus(id, value); toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success'); await loadAndRenderReports(); }catch(e){ console.error(e); toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
}

// initial visible
(function init(){ document.getElementById('reportCard').classList.remove('hidden'); })();

</script>

</body>
</html>
